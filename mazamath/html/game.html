<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Generated by GameMaker:HTML5 http://www.yoyogames.com/gamemaker/html5 -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name ="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta charset="utf-8"/>

        <!-- Set the title bar of the page -->
        <title>LCM - Bridge to Lanka</title>

        <!-- Set the background colour of the document -->
        <style>
            body {
              background: #222;
              color:#cccccc;
              margin: 0px;
              padding: 0px;
              border: 0px;
            }
            canvas {
                      image-rendering: optimizeSpeed;
                      -webkit-interpolation-mode: nearest-neighbor;
                      margin: 0px;
                      padding: 0px;
                      border: 0px;
            }
            div.gm4html5_div_class
            {
              margin: 0px;
              padding: 0px;
              border: 0px;
            }
            :-webkit-full-screen {
               width: 100%;
               height: 100%;
            }
        </style>
      <script src='/_ah/channel/jsapi'></script>
    </head>

    <body>
    <script type='text/javascript'>
      var MOVE_STATE_NOT_STARTED = -1;
      var MOVE_STATE_OVER = 0;
      var MOVE_STATE_READY = 3;
      var MOVE_STATE_AWAITING_A = 1;
      var MOVE_STATE_AWAITING_B = 2;
      var gameState = {
        game_key: '{{ game_key }}',
        me: '{{ me }}',
        nameA: '',
        nameB: ''
      };

      sendMessage = function(path, opt_param) {
        path += '?g=' + gameState.game_key;
        if (opt_param) {
          path += '&' + opt_param;
        }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', path, true);
        xhr.send();
      };

      onOpened = function() {
        sendMessage('/opened');
      };
      
      updateGame = function() {
        if (!gameState.playerB || gameState.playerB == '') {
          document.getElementById('other-player').style.display = 'block';
          document.getElementById('lcmgame').style.display = 'none';
          return;
        } else {
          document.getElementById('other-player').style.display = 'none';
          document.getElementById('lcmgame').style.display = 'block';
        }
        if ((gameState.move_state == MOVE_STATE_AWAITING_A && gameState.playerA == gameState.me) ||
            (gameState.move_state == MOVE_STATE_AWAITING_B && gameState.playerB == gameState.me)) {
          document.getElementById('waiting-my-move').style.display = 'block';
        } else {
          document.getElementById('waiting-my-move').style.display = 'none';
        }
        if ((gameState.move_state == MOVE_STATE_AWAITING_B && gameState.playerA == gameState.me) ||
            (gameState.move_state == MOVE_STATE_AWAITING_A && gameState.playerB == gameState.me)) {
          document.getElementById('waiting-other-move').style.display = 'block';
        } else {
          document.getElementById('waiting-other-move').style.display = 'none';
        }                
      }
      
      onMessage = function(m) {
        newGameState = JSON.parse(m.data);
        gameState.state = newGameState.state || gameState.state;
        gameState.playerA = newGameState.playerA || gameState.playerA;
        gameState.nameA = newGameState.nameA || gameState.nameA;
        gameState.playerB = newGameState.playerB || gameState.playerB;
        gameState.nameB = newGameState.nameB || gameState.nameB;
        gameState.moveA = newGameState.moveA;
        gameState.moveB = newGameState.moveB;
        gameState.move_state = newGameState.move_state;
        gameState.random = newGameState.random || gameState.random;
        updateGame();
      }
      
      openChannel = function() {
        var token = '{{ token }}';
        var channel = new goog.appengine.Channel(token);
        var handler = {
          'onopen': onOpened,
          'onmessage': onMessage,
          'onerror': function() {},
          'onclose': function() {}
        };
        var socket = channel.open(handler);
        socket.onopen = onOpened;
        socket.onmessage = onMessage;
      }
      
      initialize = function() {
        openChannel();
        onMessage({data: '{{ initial_message }}'});
      }      

      setTimeout(initialize, 100);

    </script>
        <div class="gm4html5_div_class" id="lcmgame" style="display:none">
            <!-- Create the canvas element the game draws to -->
            <canvas id="canvas" width="640" height="480">
               <p>Your browser doesn't support HTML5 canvas.</p>
            </canvas>
        </div>

      <div id='other-player' style='display:none'>
        Waiting for another player to join.<br>
        Send them this link to play:<br>
        <div id='game-link'><a href='{{ game_link }}'>{{ game_link }}</a></div>
      </div>

      <div id='waiting-my-move' style='display:none'>
        Waiting for your move.
      </div>

      <div id='waiting-other-move' style='display:none'>
        Waiting for other player to move.
      </div>

      <div id='this-game' float='top'>
        Quick link to this game: <span id='this-game-link'><a href='{{ game_link }}'>{{ game_link }}</a></span>
      </div>
        <!-- Run the game code -->
        <script type="text/javascript" src="html5game/lcm2.js?ILZAC=750115316"></script>
    </body>
</html>
